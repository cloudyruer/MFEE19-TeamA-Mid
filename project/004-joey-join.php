<?php include __DIR__ . '/partials/init.php';
$title = '快速加入';
$activeLi = 'joey';if (!isset($_SESSION['user'])) {header('Location: ./login.php');exit;}?><?php include __DIR__ . '/partials/html-head.php';?><?php include __DIR__ . '/partials/navbar.php';?><link crossorigin=""href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="rel="stylesheet"><style>html{scroll-behavior:smooth}body{background-color:#151b29}.geo_box{color:#ffa260;border:2px solid;border-radius:5px}.info{font-size:1.3rem;display:flex;justify-content:space-between;align-items:baseline;margin-bottom:1.2rem;font-weight:700}.geo_btn{background:0 0;color:#ffa260;border:2px solid;transition:.2s;font-size:1.3rem;font-weight:600;border-radius:20px;animation:.6s ease-in infinite alternate btnShine}.geo_btn:hover{border-color:#f1ff5c;color:#f1ff5c;box-shadow:0 .5rem .5rem -.4rem #f1ff5c;transform:translateY(-.25rem);animation-play-state:paused}.geo_btn:active{transform:translateY(0)}.geo_btn_shine{border-color:#f1ff5c;color:#f1ff5c;box-shadow:0 .5rem .5rem -.4rem #f1ff5c;transform:translateY(-.25rem);animation:.6s ease-in infinite alternate btnPopping}.confirm_btn{background:0 0;color:#8a5026;border:2px solid;transition:.2s;font-size:1.3rem;font-weight:600;border-radius:20px;margin-top:30px}.confirm_btn_after{color:#f1ff5c;animation:.6s ease-in infinite alternate btnPopping}.confirm_btn_after:hover{border-color:#f1ff5c;color:#f1ff5c;box-shadow:0 .5rem .5rem -.4rem #f1ff5c;transform:translateY(-.25rem);animation-play-state:paused}@keyframes btnShine{from{box-shadow:0 0 1rem 0 #f1ff5c}to{box-shadow:0 0 0 -.6rem #f1ff5c}}@keyframes btnPopping{from{transform:translateY(-.25rem);box-shadow:0 0 1rem 0 #f1ff5c}to{transform:translateY(0);box-shadow:0 0 0 -.6rem #f1ff5c}}#map{height:88vh;width:100%}.leaflet-popup{background-color:#151b29;border-radius:0 0 20px 20px}.leaflet-popup .leaflet-popup-content-wrapper{background-color:#151b29;color:#ffa260;border-radius:16% 84% 0 100%/100% 0}.leaflet-popup .leaflet-popup-tip{background-color:#151b29}.leaflet-popup-tip-container{overflow:visible}.leaflet-popup .leaflet-popup-content{font-size:1rem}.swim_style{background-color:#0ff}.run_style{background-color:#ff4500}.hike_style{background-color:#adff2f}.workout_style{background-color:grey}.other_style{background-color:#ff0}.hike_style:hover,.other_style:hover,.run_style:hover,.swim_style:hover,.workout_style:hover{z-index:1000}.leaflet-container a{color:#ffa260}</style></head><body> <div class="container mt-3"><div class="row align-items-stretch"><div class="col-md-6 col-lg-4"><div class="align-items-center d-flex flex-column geo_box h-100 justify-content-center px-5"><h3 class="font-weight-bold mb-4 mt-2 title">嗨！<?=$_SESSION['user']['nickname']?></h3><div class="w-100 info px-1">緯度:<span class="lat">待確認</span></div><div class="w-100 info px-1">經度:<span class="lng">待確認</span></div><div class="w-100 info px-1">城市:<span class="city">待確認</span></div><div class="w-100 info px-1">區域: <span class="locality">待確認</span></div><div class="w-100 info px-1">誤差:<span class="accuracy">待確認</span></div><button class="w-100 py-2 geo_btn mt-1">取得<?=$_SESSION['user']['nickname']?>的位置</button> <button class="w-100 py-2 confirm_btn"disabled>請先選擇開始位置</button></div></div><div class="col-md-6 col-lg-8"><div class="mapBox"id="map"></div></div></div></div><div class="container mt-5"><div class="row"><div class="col"><table class="info_box table table-bordered table-dark table-striped text-center"></table></div></div></div><?php include __DIR__ . '/partials/scripts.php';?><script crossorigin=""integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>const titleText=document.querySelector(".title"),latText=document.querySelector(".lat"),lngText=document.querySelector(".lng"),cityText=document.querySelector(".city"),localityText=document.querySelector(".locality"),accuracyText=document.querySelector(".accuracy"),geoBtn=document.querySelector(".geo_btn"),confirmBtn=document.querySelector(".confirm_btn"),geoLocation=()=>new Promise((e,t)=>{const o={enableHighAccuracy:!0,timeout:1/0,maximumAge:0};navigator.geolocation.getCurrentPosition(e,()=>t(new Error("☜(ﾟヮﾟ☜) 請允許瀏覽器讀取您的位置資料 QQ")),o)}),geoReverse=async(e,t)=>{const o=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${e}&longitude=${t}&localityLanguage=zh`);if(!o.ok)throw new Error("Problem with geoReverse");return await o.json()},map=L.map("map").setView([25.03382,121.5434],15);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);const initMarker=L.marker([25.03382,121.5434]).addTo(map).bindPopup("我們的公司在這裡歐👍").openPopup();let userPick,curCircle,curMarker,userLat,userLng;window.addEventListener("click",()=>initMarker.remove()),map.on("click",async e=>{window.scrollTo(0,0);const{lat:t,lng:o}=e.latlng,n=await geoReverse(t,o);let{city:r}=n,{locality:a}=n;"桃園縣"===r&&(r="桃園市",a=a.slice(0,-1)+"區"),curMarker?.remove(),curCircle?.remove(),curMarker=L.marker([t,o]).addTo(map).bindPopup("您選擇的位置").openPopup(),curCircle=L.circle([t,o],{color:"red",fillColor:"#f03",fillOpacity:.1,radius:1500}).addTo(map),titleText.innerText="您的位置是在:",geoBtn.style.animation="none",titleText.innerText="您選擇的位置:",latText.innerText=t.toFixed(6),lngText.innerText=o.toFixed(6),accuracyText.innerText="零誤差❤",cityText.innerText=r,localityText.innerText=a;let i="";if(userLat&&userLng){i=`<br>距離您 ${map.distance([t,o],[userLat,userLng]).toFixed(0)} (米)`}surMarker.map(e=>e.remove()),surMarker=[],map.flyTo([t,o],15),userPick?.remove(),userPick=L.marker([t,o]).addTo(map).bindPopup(L.popup({maxWidth:250,minWidth:100,autoClose:!1,closeOnClick:!1,className:"map_icon"})).setPopupContent(`<strong>選擇的地點位於:<br>${r}${a}${i}</strong>`).openPopup()});const fetchLocationInfo=async()=>{try{window.scrollTo(0,0),userPick?.remove(),titleText.innerText="計算中";const e=await new Promise((e,t)=>{const o={enableHighAccuracy:!0,timeout:1/0,maximumAge:0};navigator.geolocation.getCurrentPosition(e,()=>t(new Error("☜(ﾟヮﾟ☜) 請允許瀏覽器讀取您的位置資料 QQ")),o)}),{latitude:t}=e.coords,{longitude:o}=e.coords,{accuracy:n}=e.coords;userLat=t,userLng=o;const r=await geoReverse(t,o);let{city:a}=r,{locality:i}=r;"桃園縣"===a&&(a="桃園市",i=i.slice(0,-1)+"區"),latText.innerText=t.toFixed(6),lngText.innerText=o.toFixed(6),accuracyText.innerText=n.toFixed(1)+" (米)",cityText.innerText=a,localityText.innerText=i,titleText.innerText="您的位置是在:",geoBtn.innerText="回到我的位置 🚴‍♂️",geoBtn.style.animation="none",curMarker?.remove(),curCircle?.remove(),surMarker.map(e=>e.remove()),surMarker=[],curMarker=L.marker([t,o]).addTo(map).bindPopup("您的當前位置").openPopup(),curCircle=L.circle([t,o],{color:"red",fillColor:"#f03",fillOpacity:.1,radius:1500}).addTo(map),map.flyTo([t,o],15)}catch(e){alert(e.message)}};geoBtn.addEventListener("click",fetchLocationInfo);const infoObserver=new MutationObserver((function(e){e.forEach((function(e){confirmBtn.innerText="以當前顯示位置搜尋",confirmBtn.classList.add("confirm_btn_after"),confirmBtn.disabled=!1,infoObserver.disconnect()}))})),config={childList:!0};infoObserver.observe(latText,config);let surMarker=[];const infoBox=document.querySelector(".info_box");let bodyInfo;infoBox.innerHTML="歡迎蒞臨本網站",confirmBtn.addEventListener("click",()=>{window.scrollTo(0,0),infoBox.innerHTML="",bodyInfo="";const e=new FormData;e.append("lat",latText.textContent),e.append("lng",lngText.textContent),fetch("004-joey-join-api.php",{method:"POST",body:e}).then(e=>e.json()).then(e=>{if(!e.result)return window.scrollTo(0,0),alert(e.error);e.rowCount;surMarker.map(e=>e.remove()),surMarker=[],e.result.map(e=>{const{nickname:t,id:o,lat:n,lng:r,city:a,locality:i,distance:c,activity_detail:l,activity_type:s,created_at:d,changed_at:u}=e,p={title:l.slice(0,15)+"...",riseOnHover:!0};let m="";switch(s){case"游泳":m="swim_style";break;case"跑步":m="run_style";break;case"爬山":m="hike_style";break;case"健身":m="workout_style";break;default:m="other_style"}surMarker.push(L.marker([n,r],p).addTo(map).bindPopup(L.popup({maxWidth:250,minWidth:100,autoClose:!1,closeOnClick:!1,className:m})).setPopupContent(`<a data-id=${o} href="#${o}"\n              >${t}想要${s}<br>距離參照點${c}(米)</a>`).openPopup()),bodyInfo+=`\n              <tr id=${o}>\n                <td>${t}</td>\n                <td>${a}</td>\n                <td>${i}</td>\n                <td>${s}</td>\n                <td>${l}</td>\n                <td>${c}公尺</td>\n                <td>${u}</td>\n                <td>\n                  <a href="#">\n                    <i class="fas fa-user-plus"></i>\n                  </a>\n                </td>\n              </tr>`}),map.setZoom(15);let t=`<thead>\n              <tr>\n                <th scope="col">暱稱</th>\n                <th scope="col">城市</th>\n                <th scope="col">區域</th>\n                <th scope="col">類型</th>\n                <th scope="col">活動資訊</th>\n                <th scope="col">距離您的參照點</th>\n                <th scope="col">最後編輯時間</th>\n                <th scope="col"><i class="fas fa-user-plus"></i></th>\n              </tr>\n            </thead>\n            <tbody>\n              ${bodyInfo}\n            </tbody>`;infoBox.innerHTML=t})});const mapBox=document.querySelector(".mapBox");mapBox.addEventListener("click",e=>{if(e.target.dataset.id){document.getElementById(""+e.target.dataset.id).classList.toggle("bg-secondary")}});</script><?php include __DIR__ . '/partials/html-foot.php';?>