<?php include __DIR__ . '/partials/init.php';
$title = 'DataList';
$activeLi = 'joey';if (!isset($_SESSION['user'])) {header('Location: ./login.php');exit;}
$perPage = 5;
$qs = [];
$keyword = isset($_GET['keyword']) ? $_GET['keyword'] : '';
$specificUser = " AND valid=1 AND account= " . "'" . $_SESSION['user']['account'] . "'";
$order = 'changed_at DESC';if ($_SESSION['user']['account'] == "pikachu") {$specificUser = "";
    $order = 'nickname, changed_at DESC';}
$where = " WHERE 1 $specificUser ";if (!empty($keyword)) {$where .= sprintf(" AND `nickname` LIKE %s ", $pdo->quote('%' . $keyword . '%'));
    $qs['keyword'] = $keyword;}
$page = isset($_GET['page']) ? intval($_GET['page']) : 1;
$totalRows = $pdo->query("SELECT count(account) AS num FROM geo_info JOIN members ON members.id = members_id $where")->fetch()['num'];
$totalPages = ceil($totalRows / $perPage);
$rows = [];if ($totalRows) {if ($page < 1) {header('Location: ?page=1');exit;}if ($page > $totalPages) {header('Location: ?page=' . $totalPages);exit;}
    $sql = sprintf("SELECT geo_info.id, nickname , city, locality, activity_type,activity_detail, valid, changed_at\n        FROM geo_info JOIN members\n        ON members.id = members_id %s ORDER BY %s LIMIT %s, %s", $where, $order, ($page - 1) * $perPage, $perPage);
    $rows = $pdo->query($sql)->fetchAll();}?><?php include __DIR__ . '/partials/html-head.php'?><?php include __DIR__ . '/partials/navbar.php'?>
<style>table tbody i.fas.fa-trash-alt{color:red;cursor:pointer}table tbody i.fas.fa-trash-alt.ajaxDelete{color:#ff8c00;cursor:pointer}table tbody i.far.fa-eye.ajaxDelete{cursor:pointer}table tbody i.far.fa-eye-slash.ajaxBack{cursor:pointer}.u-confirm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;background-color:#fff;padding:3rem;border-radius:5px;box-shadow:0 3rem 5rem rgba(0,0,0,.3);z-index:10}.u-close{position:absolute;top:-.5rem;right:1rem;font-size:3rem;color:#333;cursor:pointer;border:none;background:0 0}.overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);backdrop-filter:blur(3px);z-index:5}</style><div class="container mt-3"><div class="row mb-3" ><?php if ($_SESSION['user']['account'] == "pikachu"): ?><div class="col"><h2><?="管理者帳號 {$_SESSION['user']['account']} "?> </h2><span>※管理者功能以黃色背景標示</span></div>
<div class="col"><form action="004-joey-datalist.php" class="form-inline my-2 my-lg-0 d-flex justify-content-end"><input class="form-control mr-sm-2" type="search" name="keyword" placeholder="Search" value="<?=htmlentities($keyword)?>" aria-label="Search"><button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button></form></div><?php endif?></div><nav aria-label="Page navigation example"><ul class="pagination justify-content-between"><li class="page-item  <?=$page <= 1 ? 'disabled' : ''?>"><a class="page-link" href="?<?php $qs['page'] = $page - 1?><?=http_build_query($qs)?>">Previous</a></li>
<div class="centerBox d-flex"><?php if ($page >= 4 and $totalPages > 5): ?><li class="page-item"><a class="page-link" href="?<?php $qs['page'] = 1?><?=http_build_query($qs)?>">1</a></li><li class="page-item""><a class="page-link" style="border-top: none; border-bottom:none; background-color:transparent;">...</a></li><?php endif?><?php if ($totalPages <= 5): ?><?php for ($i = 1; $i <= $totalPages; $i++): ?><?php $qs['page'] = $i?><li class="page-item <?=$i == $page ? 'active' : ''?>"><a class="page-link" href="?<?=http_build_query($qs)?>"><?=$i?></a></li><?php endfor?><?php else: ?><?php for ($i = $page - 2; $i <= $page + 2; $i++): ?><?php if ($i >= 1 and $i <= $totalPages): ?><?php $qs['page'] = $i?><li class="page-item <?=$i == $page ? 'active' : ''?>"><a class="page-link" href="?<?=http_build_query($qs)?>"><?=$i?></a></li><?php endif?><?php endfor?><?php endif?><?php if (($totalPages - $page > 2) and $totalPages > 5): ?><li class="page-item""><a class="page-link" style="border-top: none; border-bottom:none; background-color:transparent;">...</a></li><li class="page-item"><a class="page-link" href="?<?php $qs['page'] = $totalPages?><?=http_build_query($qs)?>"><?=$totalPages?></a></li><?php endif?></div><li class="page-item <?=$page >= $totalPages ? 'disabled' : ''?>"><a class="page-link" href="?<?php $qs['page'] = $page + 1?><?=http_build_query($qs)?>">Next</a></li></ul></nav><div class="row"><div class="col"><table class="table table-bordered table-dark table-striped text-center"><thead><tr><th scope="col">暱稱</th><th scope="col">城市</th><th scope="col">區域</th><th scope="col">類別</th><th scope="col">活動內容</th><th scope="col">最後編輯時間(新→舊)</th><th scope="col"><i class="fas fa-edit"></i></th><th scope="col"><i class="fas fa-trash-alt"></i></th><?php if ($_SESSION['user']['account'] == "pikachu"): ?><td class="bg-warning text-dark"><i class="far fa-eye"></i></td><td class="bg-warning text-dark"><i class="fas fa-trash-alt realDelete"></i></td><?php endif?></tr></thead><tbody><?php foreach ($rows as $r): ?><tr data-id="<?=$r['id']?>"><th scope="row"><?=$r['nickname']?></th><td><?=htmlentities($r['city'])?></td><td><?=htmlentities($r['locality'])?></td><td><?=htmlentities($r['activity_type'])?></td><td><?=htmlentities($r['activity_detail'])?></td><td><?=htmlentities($r['changed_at'])?></td><td><a href="004-joey-data-edit.php?id=<?=$r['id']?>"><i class="fas fa-edit"></i></a></td><?php if ($r['valid'] == "1"): ?><td><i class="fas fa-trash-alt ajaxDelete"></i></td><?php else: ?><td><i class="fas fa-ban"></i></td><?php endif?><?php if ($_SESSION['user']['account'] == "pikachu"): ?><?php if ($r['valid'] == "1"): ?><td><i class="far fa-eye ajaxDelete"></i></td><?php else: ?><td><i class="far ajaxBack fa-eye-slash"></i></td><?php endif?><td><i class="fas fa-trash-alt realDelete"></i></td><?php endif?></tr><?php endforeach?></tbody></table></div></div><div class="d-none text-center u-confirm"><button class="u-close">×</button><?php if ($_SESSION['user']['account'] !== "pikachu"): ?><h3>請問確定要刪除<span id="targetSid"></span>嗎?</h3><p>刪除後將無法恢復</p><?php else: ?><h4>請問確定要於用戶端隱藏<span id="targetSid"></span>嗎?</h4><p>※非管理者帳號會顯示以下提示:</p><p>「刪除後將無法恢復」</p><?php endif?><div class="d-flex justify-content-center"><button class="mx-2 u-confirm-btn">確定</button> <button class="mx-2 u-cancel-btn">取消</button></div></div><div class="d-none overlay"></div><?php include __DIR__ . '/partials/scripts.php'?><script>const myTable=document.querySelector("table"),confirmBtn=document.querySelector(".u-confirm-btn"),cancelBtn=document.querySelector(".u-cancel-btn"),confirmBox=document.querySelector(".u-confirm"),btnClose=document.querySelector(".u-close"),overlay=document.querySelector(".overlay"),closeModal=()=>{confirmBox.classList.add("d-none"),overlay.classList.add("d-none")},showModal=()=>{confirmBox.classList.remove("d-none"),overlay.classList.remove("d-none")};let tr,id;myTable.addEventListener("click",e=>{e.target.classList.contains("ajaxDelete")&&(tr=e.target.closest("tr"),id=tr.dataset.id,confirmBox.classList.remove("d-none"),overlay.classList.remove("d-none"))}),cancelBtn.addEventListener("click",()=>{closeModal()}),btnClose.addEventListener("click",()=>{closeModal()}),overlay.addEventListener("click",()=>{closeModal()}),confirmBtn.addEventListener("click",()=>{id&&fetch("004-joey-delete-api.php?id="+id).then(e=>e.json()).then(e=>{e.success?(closeModal(),location.reload()):alert(e.error)})}),myTable.addEventListener("click",e=>{if(e.target.classList.contains("ajaxBack")){tr=e.target.closest("tr"),id=tr.dataset.id;if(!confirm("請問要重新於用戶端顯示該筆資料嗎?"))return;if(!id)return;fetch("004-joey-back-api.php?id="+id).then(e=>e.json()).then(e=>{e.success?location.reload():alert(e.error)})}}),myTable.addEventListener("click",e=>{if(e.target.classList.contains("realDelete")){tr=e.target.closest("tr"),id=tr.dataset.id;if(!confirm("請問要於資料庫永久刪除該筆資料嗎?"))return;if(!id)return;fetch("004-joey-realDelete-api.php?id="+id).then(e=>e.json()).then(e=>{e.success?location.reload():alert(e.error)})}});</script><?php include __DIR__ . '/partials/html-foot.php'?>
