<?php include __DIR__ . '/partials/init.php';
$title = 'Hi Joey!!';
$activeLi = 'joey';if (!isset($_SESSION['user'])) {header('Location: ./login.php');exit;}?><?php include __DIR__ . '/partials/html-head.php';?><?php include __DIR__ . '/partials/navbar.php';?>
<link crossorigin=""href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="rel="stylesheet"><style>body{background-color:#151b29}.geo_box{color:#ffa260;border:2px solid;border-radius:5px}.info{font-size:1.3rem;display:flex;justify-content:space-between;align-items:baseline;margin-bottom:1.2rem;font-weight:700}.geo_btn{background:0 0;color:#ffa260;border:2px solid;transition:all .2s;font-size:1.3rem;font-weight:600;border-radius:20px;animation:btnShine .6s ease-in infinite alternate}.geo_btn:hover{border-color:#f1ff5c;color:#f1ff5c;box-shadow:0 .5rem .5rem -.4rem #f1ff5c;transform:translateY(-.25rem);animation-play-state:paused}.geo_btn:active{transform:translateY(0)}.geo_btn_shine{border-color:#f1ff5c;color:#f1ff5c;box-shadow:0 .5rem .5rem -.4rem #f1ff5c;transform:translateY(-.25rem);animation:btnPopping .6s ease-in infinite alternate}@keyframes btnShine{from{box-shadow:0 0 1rem 0 #f1ff5c}to{box-shadow:0 0 0 -.6rem #f1ff5c}}@keyframes btnPopping{from{transform:translateY(-.25rem);box-shadow:0 0 1rem 0 #f1ff5c}to{transform:translateY(0);box-shadow:0 0 0 -.6rem #f1ff5c}}#map{height:50vh;width:100%}.leaflet-popup .leaflet-popup-content-wrapper{background-color:#151b29;color:#ffa260;border-radius:15px}.leaflet-popup .leaflet-popup-tip{background-color:#151b29}.leaflet-popup .leaflet-popup-content{font-size:1rem}</style><body><div class="container mt-3"><div class="row align-items-stretch"><div class="col-md-6 col-lg-4"><div class="align-items-center d-flex flex-column geo_box h-100 justify-content-center px-5"><h3 class="font-weight-bold mb-4 mt-2 title">å—¨ï¼<?=$_SESSION['user']['nickname']?></h3><div class="w-100 info px-1">ç·¯åº¦:<span class="lat">å¾…ç¢ºèª</span></div><div class="w-100 info px-1">ç¶“åº¦:<span class="lng">å¾…ç¢ºèª</span></div><div class="w-100 info px-1">åŸå¸‚:<span class="city">å¾…ç¢ºèª</span></div><div class="w-100 info px-1">å€åŸŸ: <span class="locality">å¾…ç¢ºèª</span></div><div class="w-100 info px-1">èª¤å·®:<span class="accuracy">å¾…ç¢ºèª</span></div><button class="w-100 geo_btn mt-1 py-2">ä»¥<?=$_SESSION['user']['nickname']?>çš„ä½ç½®å»ºç«‹æ´»å‹•</button></div></div><div class="col-md-6 col-lg-8"><div id="map"></div></div></div></div><div class="container mt-4"><div class="row"><div class="col"><div class="card"><div class="card-body"><h5 class="card-title">ä»¥æ‰€é¸ä½ç½®ç™¼èµ·æ–°æ´»å‹•</h5><form id="geoForm"name="geoForm"><div class="first-line"><div class="form-group"><label for="activity_type">æ´»å‹•é¡å‹</label> <select class="form-control"id="activity_type"name="activity_type"><option value=""disabled selected>-- è«‹é¸æ“‡æ´»å‹•é¡å‹ --</option><option value="è·‘æ­¥">è·‘æ­¥</option><option value="çˆ¬å±±">çˆ¬å±±</option><option value="æ¸¸æ³³">æ¸¸æ³³</option><option value="å¥èº«">å¥èº«</option><option value="å…¶ä»–">å…¶ä»–</option></select> <small class="form-text invisible text-danger typeWarn">è«‹é¸æ“‡æ´»å‹•é¡å‹</small></div></div><div class="form-group"><label for="activity_detail">æ´»å‹•å…§å®¹</label> <textarea class="form-control"cols="30"id="activity_detail"name="activity_detail"placeholder="è«‹è¼¸å…¥æ´»å‹•å…§å®¹ 15~255å­—"rows="1"style="resize:none"></textarea> <small class="form-text invisible text-danger detailWarn">è«‹è¼¸å…¥15~255å­—çš„æ´»å‹•å…§å®¹</small></div><button class="btn btn-primary"type="submit">å»ºç«‹</button></form></div></div></div></div></div><?php include __DIR__ . '/partials/scripts.php';?><script crossorigin=""integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>const titleText=document.querySelector(".title"),latText=document.querySelector(".lat"),lngText=document.querySelector(".lng"),cityText=document.querySelector(".city"),localityText=document.querySelector(".locality"),accuracyText=document.querySelector(".accuracy"),geoBtn=document.querySelector(".geo_btn"),geoLocation=()=>new Promise((e,t)=>{const o={enableHighAccuracy:!0,timeout:1/0,maximumAge:0};navigator.geolocation.getCurrentPosition(e,()=>t(new Error("â˜œ(ï¾Ÿãƒ®ï¾Ÿâ˜œ) è«‹å…è¨±ç€è¦½å™¨è®€å–æ‚¨çš„ä½ç½®è³‡æ–™ QQ")),o)}),geoReverse=async(e,t)=>{const o=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${e}&longitude=${t}&localityLanguage=zh`);if(!o.ok)throw new Error("Problem with geoReverse");return await o.json()},map=L.map("map").setView([25.03382,121.5434],17);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);const initMarker=L.marker([25.03382,121.5434]).addTo(map).bindPopup("æˆ‘å€‘çš„å…¬å¸åœ¨é€™è£¡æ­ğŸ‘").openPopup();let userPick,curCircle,curMarker,userLat,userLng;window.addEventListener("click",()=>initMarker.remove()),map.on("click",async e=>{const{lat:t,lng:o}=e.latlng,r=await geoReverse(t,o);let{city:n}=r,{locality:a}=r;"æ¡ƒåœ’ç¸£"===n&&(n="æ¡ƒåœ’å¸‚",a=a.slice(0,-1)+"å€"),titleText.innerText="æ‚¨é¸æ“‡çš„ä½ç½®:",latText.innerText=t.toFixed(6),lngText.innerText=o.toFixed(6),accuracyText.innerText="é›¶èª¤å·®â¤",cityText.innerText=n,localityText.innerText=a;let i="";if(userLat&&userLng){i=`<br>è·é›¢æ‚¨ ${map.distance([t,o],[userLat,userLng]).toFixed(0)} (ç±³)`}map.flyTo([t,o],17),userPick?.remove(),userPick=L.marker([t,o]).addTo(map).bindPopup(L.popup({maxWidth:250,minWidth:100,autoClose:!1,closeOnClick:!1,className:"map_icon"})).setPopupContent(`<strong>é¸æ“‡çš„åœ°é»ä½æ–¼:<br>${n}${a}${i}</strong>`).openPopup()});const fetchLocationInfo=async()=>{try{userPick?.remove(),titleText.innerText="è¨ˆç®—ä¸­";const e=await new Promise((e,t)=>{const o={enableHighAccuracy:!0,timeout:1/0,maximumAge:0};navigator.geolocation.getCurrentPosition(e,()=>t(new Error("â˜œ(ï¾Ÿãƒ®ï¾Ÿâ˜œ) è«‹å…è¨±ç€è¦½å™¨è®€å–æ‚¨çš„ä½ç½®è³‡æ–™ QQ")),o)}),{latitude:t}=e.coords,{longitude:o}=e.coords,{accuracy:r}=e.coords;userLat=t,userLng=o;const n=await geoReverse(t,o);let{city:a}=n,{locality:i}=n;"æ¡ƒåœ’ç¸£"===a&&(a="æ¡ƒåœ’å¸‚",i=i.slice(0,-1)+"å€"),latText.innerText=t.toFixed(6),lngText.innerText=o.toFixed(6),accuracyText.innerText=r.toFixed(1)+" (ç±³)",cityText.innerText=a,localityText.innerText=i,titleText.innerText="æ‚¨çš„ä½ç½®æ˜¯åœ¨:",geoBtn.innerText="é»æ“Šå†æ¬¡å°‹æ‰¾ ğŸš´â€â™‚ï¸",geoBtn.classList.add("geo_btn_shine"),curMarker?.remove(),curCircle?.remove(),curMarker=L.marker([t,o]).addTo(map).bindPopup("æ‚¨çš„ç•¶å‰ä½ç½®").openPopup(),curCircle=L.circle([t,o],{color:"red",fillColor:"#f03",fillOpacity:.1,radius:1500}).addTo(map),map.flyTo([t,o],14)}catch(e){alert(e.message)}};geoBtn.addEventListener("click",fetchLocationInfo);const geoForm=document.querySelector("#geoForm");geoForm.addEventListener("submit",e=>{e.preventDefault();let t=!0;const o=document.querySelector("#activity_type"),r=document.querySelector("#activity_detail"),n=document.querySelector(".typeWarn"),a=document.querySelector(".detailWarn"),i=(e,t)=>{if(t)return e.classList.remove("invisible");e.classList.add("invisible")};if("å¾…ç¢ºèª"==latText.textContent)return alert("è«‹å…ˆæ–¼åœ°åœ–ä¸Šé¸æ“‡ç™¼èµ·æ´»å‹•çš„ä½ç½® à²¥_à²¥ ");if(i(n,!1),i(a,!1),["è·‘æ­¥","çˆ¬å±±","æ¸¸æ³³","å¥èº«","å…¶ä»–"].includes(o.value)||(i(n,!0),t=!1),(r.value.length<15||r.value.length>255)&&(i(a,!0),t=!1),!t)return;const c=new FormData(geoForm);c.append("lat",latText.textContent),c.append("lng",lngText.textContent),c.append("city",cityText.textContent),c.append("locality",localityText.textContent),fetch("./004-joey-create-api.php",{method:"POST",body:c}).then(e=>e.json()).then(e=>{if(!e.success)return alert(e.error);confirm("å»ºç«‹æˆåŠŸ!ğŸ˜\nè«‹å•æ˜¯å¦è¦æ–°å¢ä¸‹ä¸€ç­†?\né»æ“Šå–æ¶ˆå°‡è¿”å›çµ„éšŠé é¢")||(location.href="./004-joey.php"),o.value="",r.value=""})});</script><?php include __DIR__ . '/partials/html-foot.php';?>